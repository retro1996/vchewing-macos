// (c) 2022 and onwards Shaps Benkau (MIT License).
// ====================
// This code is released under the MIT license (SPDX-License-Identifier: MIT)

import SwiftUI

#if os(iOS) || os(tvOS)
  /*
   Since UICollectionView is not designed to support SwiftUI out of the box,
   we need to use a little trick to get the SwiftUI View's to ignore safeArea
   insets, otherwise our cell's will not always layout correctly.
   */
  extension UIHostingController {
    convenience init(rootView: Content, ignoreSafeArea: Bool) {
      self.init(rootView: rootView)

      if ignoreSafeArea {
        disableSafeArea()
      }
    }

    func disableSafeArea() {
      guard let viewClass = object_getClass(view) else { return }

      let viewSubclassName = String(cString: class_getName(viewClass)).appending("_IgnoreSafeArea")
      if let viewSubclass = NSClassFromString(viewSubclassName) {
        object_setClass(view, viewSubclass)
      } else {
        guard let viewClassNameUtf8 = (viewSubclassName as NSString).utf8String else { return }
        guard let viewSubclass = objc_allocateClassPair(viewClass, viewClassNameUtf8, 0) else { return }

        if let method = class_getInstanceMethod(UIView.self, #selector(getter:UIView.safeAreaInsets)) {
          let safeAreaInsets: @convention(block) (AnyObject) -> UIEdgeInsets = { _ in
            .zero
          }
          class_addMethod(
            viewSubclass, #selector(getter:UIView.safeAreaInsets), imp_implementationWithBlock(safeAreaInsets),
            method_getTypeEncoding(method)
          )
        }

        objc_registerClassPair(viewSubclass)
        object_setClass(view, viewSubclass)
      }
    }
  }
#endif
